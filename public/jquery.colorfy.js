"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _slicedToArray=function(){function e(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(r=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&a.return&&a.return()}finally{if(i)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),thisBrowser=function(){var e=window.navigator.userAgent.indexOf("MSIE ")>0,t=window.navigator.userAgent.indexOf("Chrome")>0,n=window.navigator.userAgent.indexOf("Firefox")>0,r=window.navigator.userAgent.indexOf("Safari")>0;return e?"IE":t?"Chrome":n?"Firefox":r?"Safari":void 0}(),assocArray=function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];if(Array.isArray(e))return e;var t=[];return Object.keys(e).forEach(function(n){t.unshift([n,e[n]])}),t},htmlfy=function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/\//g,"&#x2F;").replace(/\n/g,"<br>").replace(/ /g,"&nbsp;")},datafy=function(e){return e.replace(/<(?!br|\/br).+?>/gm,"").replace(/<br>/g,"\n").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&apos;/g,"'").replace(/&#x2F/g,"/").replace(/&nbsp;/g," ")},ColorNode=function(){function e(t,n,r,i){_classCallCheck(this,e),this.content=t,this.htmlfier=n,this.descriptor=assocArray(r),this.klass=i,this.subnodes=[],this.supernode=null,this.processed=!1,this.terminate=!1}return _createClass(e,[{key:"toHTML",value:function(){this.processed||this.process();var e=this.klass?"<span class='"+this.klass+"'>":"",t=this.klass?"</span>":"",n=[];if(this.terminate)n.push(this.htmlfier(this.content));else{var r=!0,i=!1,o=void 0;try{for(var s,a=this.subnodes[Symbol.iterator]();!(r=(s=a.next()).done);r=!0){var c=s.value;n.push(c.toHTML())}}catch(e){i=!0,o=e}finally{try{!r&&a.return&&a.return()}finally{if(i)throw o}}}return e+n.join("")+t}},{key:"process",value:function(){if(0==this.descriptor.length)this.terminate=!0;else{for(var t=this.descriptor.pop(),n=_slicedToArray(t,2),r=n[0],i=n[1],o=0,s=this.content,a=void 0;a=i.exec(s);){var c=s.substr(o,a.index),l=a[0];if(o=l.length+a.index,s=s.substr(o),o=0,c.length>0){var d=new e(c,this.htmlfier,this.descriptor.slice(0),null);this.subnodes.push(d)}var u=new e(l,this.htmlfier,this.descriptor.slice(0),r);this.subnodes.push(u)}var f=new e(s,this.htmlfier,this.descriptor.slice(0),null);this.subnodes.push(f)}this.processed=!0}}]),e}(),syntaxDescriptors={},_colorfy=function(e,t,n,r){return n||(n=htmlfy),new ColorNode(e,n,t,r).toHTML()},_colorfy2=function(e,t){var n=void 0;return n=jQuery?jQuery.fn.colorfy[t]:syntaxDescriptors[t],_colorfy(e,n,htmlfy,t)},parentsOfNode=function(e){for(var t=[e];e=e.parentNode;)t.unshift(e);return t},commonAncestor=function(e,t){var n=parentsOfNode(e),r=parentsOfNode(t);if(n[0]!=r[0])return null;for(var i=0,o=n.length;i<o;i++)if(n[i]!=r[i])return n[i-1]},lengthOfNode=function e(t){if(t.nodeType==Node.TEXT_NODE)return t.nodeValue.length;if("BR"==t.tagName)return 1;if("SPAN"==t.tagName||"DIV"==t.tagName){for(var n=0,r=0,i=t.childNodes.length;r<i;r++)n+=e(t.childNodes[r]);return n}return 0},lengthOfNodeToOffset=function(e,t){if(e.nodeType==Node.TEXT_NODE)return t;if("BR"==e.tagName)return t;if("SPAN"==e.tagName||"DIV"==e.tagName){for(var n=0,r=0;r<t;r++)n+=lengthOfNode(e.childNodes[r]);return n}return t},cursorLocation=function e(t,n,r,i){if(i||(i=t),i==n)return lengthOfNodeToOffset(n,r);if(!i.contains(n)&&t.contains(commonAncestor(i,n))&&i.compareDocumentPosition(n)==Node.DOCUMENT_POSITION_FOLLOWING)return lengthOfNode(i);if(!i.contains(n)&&t.contains(commonAncestor(i,n))&&i.compareDocumentPosition(n)==Node.DOCUMENT_POSITION_PRECEDING)return 0;if(i.contains(n)){for(var o=0,s=0,a=i.childNodes.length;s<a;s++)o+=e(t,n,r,i.childNodes[s]);return o}return 0},nodeAndOffset=function(e,t){var n=!0;e:for(;n;){var r=e,i=t;if(o=s=a=void 0,n=!1,lengthOfNode(i)<r)return[];if(i.nodeType==Node.TEXT_NODE)return[i,r];if("BR"==i.tagName)switch(thisBrowser){case"Chrome":return[i.nextSibling,0];case"Firefox":return"BR"==i.nextSibling.tagname?[i.nextSibling,0]:[i,0];case"IE":case"Safari":default:return[i,r]}else for(var o=0,s=i.childNodes.length;o<s;o++){var a=i.childNodes[o];if(!(lengthOfNode(a)<r)){e=r,t=a,n=!0;continue e}r-=lengthOfNode(a)}}},restoreCursor=function(e){if(document.activeElement==e){var t=window.getSelection();if(t.isCollapsed){var n=nodeAndOffset(e.getAttribute("data-cursor"),e),r=_slicedToArray(n,2),i=r[0],o=r[1];i&&o>=0&&t.collapse(i,o)}}},saveCursor=function(e){if(document.activeElement==e){var t=window.getSelection();if(t.isCollapsed){var n=t.anchorNode,r=t.anchorOffset;if(e.contains(n)){var i=cursorLocation(e,n,r);e.setAttribute("data-cursor",i)}}}},Colorfy=function(){function e(t,n){_classCallCheck(this,e),this.node=t,this.divId=n}return _createClass(e,[{key:"colorfy",value:function(e){var t=this,n=document.createElement("div");n.setAttribute("contenteditable",!0),this.divId&&n.setAttribute("id",this.divId),n.setAttribute("class",this.node.getAttribute("class")),n.style.maxHeight=this.node.clientHeight,n.style.height=this.node.clientHeight,"INPUT"==this.node.tagName?n.style.overflow="hidden":n.style.overflow="scroll",this.node.parentNode.insertBefore(n,this.node.nextSibling),this.node.style.display="none",this.colorfyTriggeredChange=!1;var r=function(){if(!t.colorfyTriggeredChange){n.dataText=t.node.value;var e=document.createEvent("CustomEvent");e.initEvent("receive-content",!0,!0),n.dispatchEvent(e)}};jQuery?jQuery(this.node).on("keyup paste change input",r):(this.node.addEventListener("keyup",r),this.node.addEventListener("paste",r),this.node.addEventListener("change",r),this.node.addEventListener("input",r));var i=function(){saveCursor(n),n.dataText=datafy(n.innerHTML);var e=document.createEvent("CustomEvent");e.initEvent("send-content",!0,!0),n.dispatchEvent(e),(e=document.createEvent("CustomEvent")).initEvent("receive-content",!0,!0),n.dispatchEvent(e)};jQuery?jQuery(n).on("input paste",i):(n.addEventListener("input",i),n.addEventListener("paste",i)),n.addEventListener("receive-content",function(t){0==("Firefox"==thisBrowser?n.textContent:n.innerText).length?n.style.display="block":n.style.display="inline-block",n.innerHTML=_colorfy2(n.dataText,e),restoreCursor(n)}),n.addEventListener("send-content",function(e){t.colorfyTriggeredChange=!0,t.node.value=n.dataText,t.colorfyTriggeredChange=!1;var r=new Event("change");t.node.dispatchEvent(r)}),n.dataText=this.node.value;var o=document.createEvent("CustomEvent");o.initEvent("receive-content",!0,!0),n.dispatchEvent(o)}}]),e}();jQuery.fn.colorfy=function(e,t){this.each(function(){new Colorfy(this,t).colorfy(e)})};